<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="implementation" />
	<meta name="description" content="implementation" />
	<!-- 网页标签标题 -->
	<title>implementation</title>
	<link rel="shortcut icon" href="/thain/img/docsite.ico"/>
	<link rel="stylesheet" href="/thain/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/thain/zh-cn/index.html"><img class="logo" src="/thain/img/thain-logo.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/thain/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/thain/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/thain/zh-cn/docs/quick_start.html" target="_self">文档</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/thain/img/system/docs.png" class="front-img"/><span>文档</span><img src="/thain/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>基本操作</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/thain/zh-cn/docs/quick_start.html" target="_self">快速启动</a></li><li style="height:72px;overflow:hidden" class="menu-item menu-item-level-2"><span>页面使用<img style="transform:rotate(0deg)" class="menu-toggle" src="/thain/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/page-usage/create-flow.html" target="_self">创建Flow</a></li></ul></li><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>定制部署<img style="transform:rotate(0deg)" class="menu-toggle" src="/thain/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/custom-deployment/database.html" target="_self">数据库</a></li><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/custom-deployment/user.html" target="_self">用户管理</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/thain/zh-cn/docs/http-callback.html" target="_self">HTTP回调</a></li></ul></li><li class="menu-item menu-item-level-1"><span>组件使用</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/thain/zh-cn/docs/component/introduction.html" target="_self">组件说明</a></li><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>std组件<img style="transform:rotate(0deg)" class="menu-toggle" src="/thain/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/component/std/shell.html" target="_self">Shell</a></li><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/component/std/http.html" target="_self">HTTP</a></li><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/component/std/mail.html" target="_self">邮件</a></li></ul></li><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>自定义组件<img style="transform:rotate(0deg)" class="menu-toggle" src="/thain/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/component/customize/definition.html" target="_self">组件定义</a></li><li class="menu-item menu-item-level-3"><a href="/thain/zh-cn/docs/component/customize/implementation.html" target="_self">组件实现</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/thain/zh-cn/docs/component/example.html" target="_self">组件组合使用示例</a></li></ul></li><li class="menu-item menu-item-level-1"><span>FAQ</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/thain/zh-cn/docs/faq/faq.html" target="_self">FAQ</a></li></ul></li></ul></div><div class="doc-content markdown-body"><!--
 Copyright (c) 2019, Xiaomi, Inc.  All rights reserved.
 This source code is licensed under the Apache License Version 2.0, which
 can be found in the LICENSE file in the root directory of this source tree.
-->
<h1>组件实现</h1>
<p>现阶段组件实现只支持 java。</p>
<h2>实现位置</h2>
<p>建议把实现统一放在路径下：</p>
<p>thain/thain-component/com.xiaomi.thain.component</p>
<h2>引入定义</h2>
<p>上一节讲了如果写一个定义，我们实现的时候，需要把之前的定义引入。</p>
<p>在类上使用 com.xiaomi.thain.component.annotation.ThainComponent 这个注解。</p>
<p>如：</p>
<pre><code class="language-java"><span class="hljs-meta">@ThainComponent</span>(<span class="hljs-string">"这里填上一节写好的mail定义"</span>)
</code></pre>
<h2>定义属性</h2>
<p>把 json 定义中的 property 放在 class 中，都用 String 类型接收。</p>
<p>如：</p>
<pre><code class="language-java"><span class="hljs-comment">/**
 * 邮件标题
 */</span>
<span class="hljs-keyword">private</span> String title;

<span class="hljs-comment">/**
 * 邮件内容，html格式
 */</span>
<span class="hljs-keyword">private</span> String contentHtml;

<span class="hljs-comment">/**
 * 邮件接收人，多个用逗号隔开
 */</span>
<span class="hljs-keyword">private</span> String recipient;
</code></pre>
<h2>辅助工具</h2>
<pre><code class="language-java">com.xiaomi.thain.component.tools.ComponentTools
</code></pre>
<p>实现一个组件，大部分情况需要用到这个工具。</p>
<p>可以在组件的属性中增加一行：</p>
<pre><code class="language-java"><span class="hljs-keyword">private</span> ComponentTools tools;
</code></pre>
<p>即可使用这个工具。</p>
<p>ComponentTools 提供了一系列方法：</p>
<pre><code class="language-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ComponentTools</span> </span>{

    <span class="hljs-comment">/**
     * 发送邮件
     * <span class="hljs-doctag">@param</span> to 收件人
     * <span class="hljs-doctag">@param</span> subject 主题
     * <span class="hljs-doctag">@param</span> content 正文
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sendMail</span><span class="hljs-params">(String[] to, String subject, String content)</span> <span class="hljs-keyword">throws</span> IOException, MessagingException</span>;

    <span class="hljs-comment">/**
     * 保存当前节点产生的数据
     *
     * <span class="hljs-doctag">@param</span> key 数据的key
     * <span class="hljs-doctag">@param</span> value 数据的value
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">putStorage</span><span class="hljs-params">(@NonNull <span class="hljs-keyword">final</span> String key, @NonNull <span class="hljs-keyword">final</span> Object value)</span></span>;

    <span class="hljs-comment">/**
     * 获取流程已经产生的数据
     *
     * <span class="hljs-doctag">@param</span> jobName 节点名称
     * <span class="hljs-doctag">@param</span> key key
     * <span class="hljs-doctag">@param</span> &lt;T&gt; 自动强制转换
     * <span class="hljs-doctag">@return</span> 返回对应值的Optional
     */</span>
    &lt;T&gt; <span class="hljs-function">Optional&lt;T&gt; <span class="hljs-title">getStorageValue</span><span class="hljs-params">(@NonNull <span class="hljs-keyword">final</span> String jobName, @NonNull <span class="hljs-keyword">final</span> String key)</span></span>;

    <span class="hljs-comment">/**
     * 获取流程已经产生的数据
     *
     * <span class="hljs-doctag">@param</span> jobName 节点名称
     * <span class="hljs-doctag">@param</span> key key
     * <span class="hljs-doctag">@param</span> defaultValue 默认值
     * <span class="hljs-doctag">@param</span> &lt;T&gt; 自动强制转换
     * <span class="hljs-doctag">@return</span> 返回对应值, 值不存在则返回defaultValue
     */</span>
    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getStorageValueOrDefault</span><span class="hljs-params">(@NonNull <span class="hljs-keyword">final</span> String jobName, @NonNull <span class="hljs-keyword">final</span> String key, @NonNull <span class="hljs-keyword">final</span> T defaultValue)</span></span>;

    <span class="hljs-comment">/**
     * 增加debug日志
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addDebugLog</span><span class="hljs-params">(String content)</span></span>;

    <span class="hljs-comment">/**
     * 增加info日志
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addInfoLog</span><span class="hljs-params">(String content)</span></span>;

    <span class="hljs-comment">/**
     * 增加warning日志
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addWarnLog</span><span class="hljs-params">(String content)</span></span>;

    <span class="hljs-comment">/**
     * 增加error日志
     *
     * <span class="hljs-doctag">@param</span> content
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">addErrorLog</span><span class="hljs-params">(String content)</span></span>;

    <span class="hljs-comment">/**
     * 发送http get 请求
     *
     * <span class="hljs-doctag">@param</span> url url
     * <span class="hljs-doctag">@param</span> data ?后面的
     */</span>
    <span class="hljs-function">String <span class="hljs-title">httpGet</span><span class="hljs-params">(@NonNull String url, @NonNull Map&lt;String, String&gt; data)</span> <span class="hljs-keyword">throws</span> IOException</span>;

    <span class="hljs-comment">/**
     * 发送 http post 请求
     *
     * <span class="hljs-doctag">@param</span> url url
     * <span class="hljs-doctag">@param</span> headers headers
     * <span class="hljs-doctag">@param</span> data data
     */</span>
    <span class="hljs-function">String <span class="hljs-title">httpPost</span><span class="hljs-params">(@NonNull String url,
                    @NonNull Map&lt;String, String&gt; headers,
                    @NonNull Map&lt;String, ?&gt; data)</span> <span class="hljs-keyword">throws</span> IOException</span>;

    <span class="hljs-comment">/**
     * 获取当前的id
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">long</span> <span class="hljs-title">getJobExecutionId</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">/**
     * 获取flow当前产生的全部结果
     */</span>
    <span class="hljs-function">Map&lt;String, Object&gt; <span class="hljs-title">getStorage</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<h2>实现执行逻辑</h2>
<p>在组件的 class 中定义一个 run 方法即可。</p>
<pre><code class="language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span>
</span></code></pre>
<h2>job 执行状态</h2>
<p>job 的执行状态取决于 run 方法中是否抛了异常。</p>
<p>如果抛了就是为失败，没抛就是为成功。</p>
</div></section><footer class="footer-container"><div class="footer-body"><div class="copyright"><span>Copyright © 2020 XIAOMI </span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '/thain';
  </script>
	<script src="/thain/build/documentation.js"></script>
</body>
</html>